{
    "name": "02485_zero_copy_commit_error.sql",
    "tests": [
        {
            "query": "-- Tags: no-fasttest\n\ncreate table rmt1 (n int, m int, k int) engine=ReplicatedMergeTree('/test/02485/{database}/rmt', '1') order by n\n    settings storage_policy='s3_cache', allow_remote_fs_zero_copy_replication=1, old_parts_lifetime=60, cleanup_delay_period=60, max_cleanup_delay_period=60, cleanup_delay_period_random_add=1, min_bytes_for_wide_part=0, simultaneous_parts_removal_limit=1;",
            "name": "02485_zero_copy_commit_error.sql"
        },
        {
            "query": "\ncreate table rmt2 (n int, m int, k int) engine=ReplicatedMergeTree('/test/02485/{database}/rmt', '2') order by n\n    settings storage_policy='s3_cache', allow_remote_fs_zero_copy_replication=1, old_parts_lifetime=0, cleanup_delay_period=0, max_cleanup_delay_period=1, cleanup_delay_period_random_add=1, min_bytes_for_wide_part=0;",
            "name": "02485_zero_copy_commit_error.sql"
        },
        {
            "query": "\n\ninsert into rmt1 values (1, 1, 1);",
            "name": "02485_zero_copy_commit_error.sql"
        },
        {
            "query": "\ninsert into rmt1 values (2, 2, 2);",
            "name": "02485_zero_copy_commit_error.sql"
        },
        {
            "query": "\nsystem sync replica rmt2 lightweight;",
            "name": "02485_zero_copy_commit_error.sql"
        },
        {
            "query": "\n\nsystem stop merges rmt2;",
            "name": "02485_zero_copy_commit_error.sql"
        },
        {
            "query": "\nsystem stop cleanup rmt1;",
            "name": "02485_zero_copy_commit_error.sql"
        },
        {
            "query": "\nsystem stop replicated sends rmt1;",
            "name": "02485_zero_copy_commit_error.sql"
        },
        {
            "query": "\n\nalter table rmt1 modify setting fault_probability_before_part_commit=1;",
            "name": "02485_zero_copy_commit_error.sql"
        },
        {
            "query": "\nalter table rmt1 update k = 0 where 0;",
            "name": "02485_zero_copy_commit_error.sql"
        },
        {
            "query": "\n\n-- give rmt1 a chance to execute MUTATE_PART (and fail)\nselect sleep(1) as test_does_not_rely_on_this format Null;",
            "name": "02485_zero_copy_commit_error.sql"
        },
        {
            "query": "\nsystem stop merges rmt1;",
            "name": "02485_zero_copy_commit_error.sql"
        },
        {
            "query": "\nsystem start merges rmt2;",
            "name": "02485_zero_copy_commit_error.sql"
        },
        {
            "query": "\n\nsystem sync replica rmt2;",
            "name": "02485_zero_copy_commit_error.sql"
        },
        {
            "query": "\n\n-- give rmt2 a chance to cleanup the source part (mutation parent)\nselect sleep(3) as test_does_not_rely_on_this format Null;",
            "name": "02485_zero_copy_commit_error.sql"
        },
        {
            "query": "\n\n-- it will remove the mutated part that it failed to commit\ndrop table rmt1 sync;",
            "name": "02485_zero_copy_commit_error.sql"
        },
        {
            "query": "\n\nselect * from rmt2 order by n;",
            "name": "02485_zero_copy_commit_error.sql"
        }
    ]
}